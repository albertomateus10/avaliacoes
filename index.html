<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliações de Veículos 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --info-color: #3498db;
            --warning-color: #f1c40f;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 20px;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-title {
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .dashboard-subtitle {
            opacity: 0.9;
            margin-top: 5px;
            font-weight: 300;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
        }
        
        .stats-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
            text-transform: uppercase;
        }
        
        .stats-card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #000;
        }
        
        .stats-card-subtitle {
            font-size: 12px;
            color: #6c757d;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            height: 450px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
        }
        
        .table-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #000;
        }
        
        .select2-container--bootstrap-5 .select2-selection {
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
            height: auto;
        }
        
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
            display: flex;
            flex-wrap: wrap;
        }
        
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }
        
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .btn-upload {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background-color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-upload:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .card-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .search-placa-container {
            position: relative;
        }
        
        .search-placa-input {
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 0.375rem 2.5rem 0.375rem 0.75rem;
            font-size: 14px;
            color: #000;
            background-color: white;
            width: 100%;
        }
        
        .search-placa-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            outline: 0;
        }
        
        .search-placa-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }
        
        .clear-search-btn {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            display: none;
        }
        
        .clear-search-btn:hover {
            color: var(--danger-color);
        }
        
        .story-highlight {
            background-color: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .story-highlight-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .story-highlight-content {
            color: #333;
            font-size: 14px;
        }
        
        .export-buttons {
            margin-bottom: 15px;
        }
        
        .btn-export {
            margin-right: 10px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-export-excel {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }
        
        .btn-export-pdf {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 15px;
            }
            
            .dashboard-title {
                font-size: 20px;
            }
            
            .dashboard-subtitle {
                font-size: 14px;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
            
            .stats-card-value {
                font-size: 22px;
            }
            
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>

<div id="dashboard">

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Cabeçalho -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="dashboard-title">Avaliações de Veículos 2025</h1>
                            <p class="dashboard-subtitle">Desenvolvido por Alberto Mateus</p>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <div class="upload-btn-wrapper">
                                <button class="btn btn-upload">
                                    <i class="fas fa-upload me-2"></i> Carregar Base
                                </button>
                                <input type="file" id="fileUpload" accept=".xlsx, .xls" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row">
            <div class="col-12">
                <div class="filter-section">
                    <h2 class="filter-title">Filtros</h2>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="buscaPlaca" class="form-label">Buscar por Placa</label>
                            <div class="search-placa-container">
                                <input type="text" class="search-placa-input" id="buscaPlaca" placeholder="Digite a placa do veículo...">
                                <button type="button" class="clear-search-btn" id="clearSearchBtn" title="Limpar busca">
                                    <i class="fas fa-times"></i>
                                </button>
                                <i class="fas fa-search search-placa-icon"></i>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="filtroMes" class="form-label">Mês</label>
                            <select class="form-select select2-multiple" id="filtroMes" multiple></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="filtroLoja" class="form-label">Loja</label>
                            <select class="form-select select2-multiple" id="filtroLoja" multiple></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="filtroVendedor" class="form-label">Vendedor</label>
                            <select class="form-select select2-multiple" id="filtroVendedor" multiple></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="filtroMarca" class="form-label">Marca</label>
                            <select class="form-select select2-multiple" id="filtroMarca" multiple></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="filtroModelo" class="form-label">Modelo</label>
                            <select class="form-select select2-multiple" id="filtroModelo" multiple></select>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 text-end">
                            <button id="btnLimparFiltros" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-eraser me-1"></i> Limpar Filtros
                            </button>
                            <button id="btnAplicarFiltros" class="btn btn-primary">
                                <i class="fas fa-filter me-1"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storytelling -->
        <div class="row">
            <div class="col-12">
                <div class="story-highlight" id="storyHighlight">
                    <h3 class="story-highlight-title">Insights das Avaliações</h3>
                    <div class="story-highlight-content" id="storyContent">
                        Carregando insights...
                    </div>
                </div>
            </div>
        </div>

        <!-- Export -->
        <div class="row">
            <div class="col-12">
                <div class="export-buttons text-end mb-3">
                    <button id="btnExportarExcel" class="btn btn-export btn-export-excel">
                        <i class="fas fa-file-excel me-1"></i> Exportar Excel
                    </button>
                    <button id="btnExportarPDF" class="btn btn-export btn-export-pdf">
                        <i class="fas fa-file-pdf me-1"></i> Exportar PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row">
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-car-side"></i>
                    </div>
                    <h3 class="stats-card-title">TOTAL DE AVALIAÇÕES</h3>
                    <div class="stats-card-value" id="totalAvaliacoes">0</div>
                    <div class="stats-card-subtitle">Avaliações realizadas</div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-tag"></i>
                    </div>
                    <h3 class="stats-card-title">TICKET MÉDIO</h3>
                    <div class="stats-card-value" id="ticketMedio">R$ 0,00</div>
                    <div class="stats-card-subtitle">Valor médio das avaliações</div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-road"></i>
                    </div>
                    <h3 class="stats-card-title">KM MÉDIA</h3>
                    <div class="stats-card-value" id="kmMedia">0</div>
                    <div class="stats-card-subtitle">Quilometragem média</div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3 class="stats-card-title">MÉDIA DE ANOS DOS VEÍCULOS</h3>
                    <div class="stats-card-value" id="mediaAnos">0</div>
                    <div class="stats-card-subtitle">Ano médio dos veículos</div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3 class="stats-card-title">CAPTAÇÃO</h3>
                    <div class="stats-card-value" id="captacaoQuantidade">0</div>
                    <div class="stats-card-subtitle">
                        <span id="captacaoPercentual">0</span>% das avaliações
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2-4 mb-4">
                <div class="stats-card">
                    <div class="card-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <h3 class="stats-card-title">PERCENTUAL FIPE</h3>
                    <div class="stats-card-value" id="percentualFipe">0%</div>
                    <div class="stats-card-subtitle">Média do percentual da FIPE</div>
                </div>
            </div>
        </div>

        <!-- Gráficos principais -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Ticket Médio por Marca</h3>
                    <canvas id="chartTicketMarca"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Ticket Médio por Vendedor</h3>
                    <canvas id="chartTicketVendedor"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráficos de quantidade -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Quantidade de Avaliações por Marca</h3>
                    <canvas id="chartAvaliacoesMarca"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Quantidade de Avaliações por Vendedor</h3>
                    <canvas id="chartAvaliacoesVendedor"></canvas>
                </div>
            </div>
        </div>

        <!-- Captação -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Top 20 Vendedores em Captação</h3>
                    <canvas id="chartCaptacaoVendedores"></canvas>
                </div>
            </div>
        </div>

        <!-- Novos gráficos -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Top 10 Modelos Mais Avaliados</h3>
                    <canvas id="chartModelosVendidos"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h3 class="chart-title">Top 10 Modelos Mais Bem Pagos (FIPE ≈ 100%)</h3>
                    <canvas id="chartModelosFipe"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="row">
            <div class="col-12">
                <div class="table-section">
                    <h3 class="table-title">Listagem de Avaliações</h3>
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabelaAvaliacoes">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Loja</th>
                                    <th>Vendedor</th>
                                    <th>Cliente</th>
                                    <th>Placa</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Ano</th>
                                    <th>KM</th>
                                    <th>Valor</th>
                                    <th>% FIPE</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div id="tableInfo" class="text-muted">
                                Mostrando 0 de 0 registros
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Paginação da tabela">
                                <ul class="pagination justify-content-end" id="tablePagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <div class="row">
            <div class="col-12">
                <div class="text-center py-3 text-muted">
                    <p>Dashboard de Avaliações de Veículos 2025 | Atualizado em <span id="dataAtualizacao"></span></p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/pt-br.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#666';
    
    let dadosCompletos = [];
    let dadosFiltrados = [];
    let filtros = {
        meses: [],
        lojas: [],
        vendedores: [],
        marcas: [],
        modelos: []
    };
    let quadros = {
        total_avaliacoes: 0,
        ticket_medio: 0,
        km_media: 0,
        media_anos: 0,
        media_percentual_fipe: 0,
        captacao_quantidade: 0,
        captacao_percentual: 0
    };
    let graficos = {
        modelos_mais_vendidos: [],
        modelos_proximos_fipe: [],
        ticket_por_marca: [],
        ticket_por_vendedor: [],
        avaliacoes_por_marca: [],
        avaliacoes_por_vendedor: [],
        captacao_por_vendedor: []
    };
    let paginaAtual = 1;
    const itensPorPagina = 10;
    let buscaPlacaAtiva = '';
    
    const formatadorMoeda = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2
    });
    
    const formatadorNumero = new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
    
    const formatadorDecimal = new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    const formatadorAno = new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1,
        useGrouping: false
    });

    const coresPrimarias = [
        'rgba(52, 152, 219, 0.8)',
        'rgba(46, 204, 113, 0.8)',
        'rgba(155, 89, 182, 0.8)',
        'rgba(52, 73, 94, 0.8)',
        'rgba(243, 156, 18, 0.8)',
        'rgba(231, 76, 60, 0.8)',
        'rgba(26, 188, 156, 0.8)',
        'rgba(241, 196, 15, 0.8)',
        'rgba(230, 126, 34, 0.8)',
        'rgba(149, 165, 166, 0.8)'
    ];
    
    const coresBordas = [
        'rgba(52, 152, 219, 1)',
        'rgba(46, 204, 113, 1)',
        'rgba(155, 89, 182, 1)',
        'rgba(52, 73, 94, 1)',
        'rgba(243, 156, 18, 1)',
        'rgba(231, 76, 60, 1)',
        'rgba(26, 188, 156, 1)',
        'rgba(241, 196, 15, 1)',
        'rgba(230, 126, 34, 1)',
        'rgba(149, 165, 166, 1)'
    ];

    let mapaCoresMarcas = {};
    
    let chartTicketMarca;
    let chartTicketVendedor;
    let chartAvaliacoesMarca;
    let chartAvaliacoesVendedor;
    let chartModelosVendidos;
    let chartModelosFipe;
    let chartCaptacaoVendedores;
    
    function processarArquivoExcel(arquivo) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: true });
                processarDados(jsonData);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Base de dados carregada com sucesso!');
            } catch (error) {
                console.error('Erro ao processar arquivo:', error);
                alert('Erro ao processar o arquivo. Verifique se é um arquivo Excel válido.');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        };
        
        reader.onerror = function() {
            alert('Erro ao ler o arquivo.');
            document.getElementById('loadingOverlay').style.display = 'none';
        };
        
        reader.readAsArrayBuffer(arquivo);
    }
    
    function processarDados(dados) {
        if (!dados || dados.length === 0) {
            alert('Arquivo não contém dados válidos.');
            return;
        }
        
        const colunas = Object.keys(dados[0]);
        const colunasNecessarias = [
            'Data de Criação',
            'Data de Avaliação',
            'Lojas',
            'Vendedor',
            'Marca',
            'Modelo',
            'Valor avaliado',
            'KM',
            'Ano Modelo',
            'FIPE',
            'Placa da Avaliação',
            'Celular',
            'Email'
        ];
        
        const colunasPresentes = colunasNecessarias.filter(col => colunas.includes(col));
        
        if (colunasPresentes.length < colunasNecessarias.length) {
            const colunasFaltantes = colunasNecessarias.filter(col => !colunas.includes(col));
            alert(`Arquivo não contém todas as colunas necessárias. Faltando: ${colunasFaltantes.join(', ')}`);
            return;
        }
        
        dadosCompletos = dados.map(item => {
            let dataCriacao = null;
            try {
                if (item['Data de Criação']) {
                    if (typeof item['Data de Criação'] === 'string') {
                        dataCriacao = moment(item['Data de Criação'], ['DD/MM/YYYY HH:mm:ss', 'YYYY-MM-DD HH:mm:ss', 'MM/DD/YYYY HH:mm:ss']);
                    } else if (typeof item['Data de Criação'] === 'number') {
                        dataCriacao = moment(new Date((item['Data de Criação'] - 25569) * 86400 * 1000));
                    }
                }
            } catch (e) {
                console.error('Erro ao converter data:', e);
            }
            
            const mesAno = dataCriacao && dataCriacao.isValid() ? dataCriacao.format('MMMM/YYYY') : 'Desconhecido';
            
            const valorAvaliado = parseFloat(item['Valor avaliado']) || 0;
            const km = parseFloat(item['KM']) || 0;
            const ano = parseFloat(item['Ano Modelo']) || 0;
            const valorFipe = parseFloat(item['FIPE']) || 0;
            
            const percentualFipe = (valorFipe > 0 && valorAvaliado > 0) ? (valorAvaliado / valorFipe) * 100 : 0;
            
            return {
                ...item,
                Modelo: String(item["Modelo"]).trim(),
                Data_Criacao: dataCriacao && dataCriacao.isValid() ? dataCriacao.format('YYYY-MM-DD HH:mm:ss') : null,
                Mes_Ano: mesAno,
                Valor_Avaliacao: valorAvaliado,
                KM: km,
                Ano: ano,
                Valor_Fipe: valorFipe,
                Percentual_FIPE: percentualFipe
            };
        });
        
        dadosCompletos = dadosCompletos.filter(item => item.Data_Criacao !== null);
        dadosFiltrados = [...dadosCompletos];
        
        extrairOpcoesFiltros();
        calcularEstatisticas();
        calcularDadosGraficos();
        inicializarInterface();
    }
    
    function extrairOpcoesFiltros() {
        const mesesUnicos = [...new Set(dadosCompletos.filter(item => String(item.Mes_Ano).endsWith("/2025")).map(item => item.Mes_Ano))];
        filtros.meses = mesesUnicos.sort((a, b) => moment(a, 'MMMM/YYYY', 'pt-br').diff(moment(b, 'MMMM/YYYY', 'pt-br')));
        
        const lojasUnicas = [...new Set(dadosCompletos.map(item => item.Lojas))].filter(Boolean);
        filtros.lojas = lojasUnicas.sort();
        
        const vendedoresUnicos = [...new Set(dadosCompletos.map(item => item.Vendedor))].filter(Boolean);
        filtros.vendedores = vendedoresUnicos.sort();
        
        const marcasUnicas = [...new Set(dadosCompletos.map(item => item.Marca))].filter(Boolean);
        filtros.marcas = marcasUnicas.sort();
        
        const modelosUnicos = [...new Set(dadosCompletos.map(item => String(item.Modelo).trim()))].filter(Boolean);
        filtros.modelos = modelosUnicos.sort();
        
        preencherFiltros();
    }
    
    function calcularEstatisticas() {
        quadros.total_avaliacoes = dadosFiltrados.length;
        
        const dadosSemZeros = dadosFiltrados.filter(item => item.Valor_Avaliacao > 0);
        quadros.ticket_medio = dadosSemZeros.length > 0 
            ? dadosSemZeros.reduce((sum, item) => sum + item.Valor_Avaliacao, 0) / dadosSemZeros.length 
            : 0;
        
        const dadosComKM = dadosFiltrados.filter(item => item.KM > 0);
        quadros.km_media = dadosComKM.length > 0 
            ? dadosComKM.reduce((sum, item) => sum + item.KM, 0) / dadosComKM.length 
            : 0;
        
        const dadosComAno = dadosFiltrados.filter(item => item.Ano > 0);
        quadros.media_anos = dadosComAno.length > 0 
            ? dadosComAno.reduce((sum, item) => sum + item.Ano, 0) / dadosComAno.length 
            : 0;
        
        const dadosComFIPE = dadosFiltrados.filter(item => item.Percentual_FIPE > 0);
        quadros.media_percentual_fipe = dadosComFIPE.length > 0 
            ? dadosComFIPE.reduce((sum, item) => sum + item.Percentual_FIPE, 0) / dadosComFIPE.length 
            : 0;

        const dadosComDataCompra = dadosFiltrados.filter(item => {
            const campo = item['Data de compra'];
            return campo !== undefined && campo !== null && String(campo).trim() !== '';
        });
        quadros.captacao_quantidade = dadosComDataCompra.length;
        quadros.captacao_percentual = quadros.total_avaliacoes > 0 
            ? (quadros.captacao_quantidade / quadros.total_avaliacoes) * 100 
            : 0;
        
        atualizarQuadros();
    }
    
    function calcularDadosGraficos() {
        const dadosSemZeros = dadosFiltrados.filter(item => item.Valor_Avaliacao > 0);

        // BASE: sempre "Data de Avaliação"
        const dadosComDataAvaliacao = dadosFiltrados.filter(item => {
            const campo = item['Data de Avaliação'];
            return campo !== undefined && campo !== null && String(campo).trim() !== '';
        });

        // Ticket Médio por Marca (Data de Avaliação)
        const ticketPorMarca = {};
        const contagemPorMarca = {};

        dadosComDataAvaliacao.forEach(item => {
            const valor = item.Valor_Avaliacao;
            if (!(valor > 0)) return;

            const marca = item.Marca || 'Não informado';

            if (!ticketPorMarca[marca]) {
                ticketPorMarca[marca] = 0;
                contagemPorMarca[marca] = 0;
            }

            ticketPorMarca[marca] += valor;
            contagemPorMarca[marca]++;
        });

        graficos.ticket_por_marca = Object.keys(ticketPorMarca).map(marca => ({
            Marca: marca,
            'Valor Avaliação': ticketPorMarca[marca] / contagemPorMarca[marca],
            'Quantidade': contagemPorMarca[marca]
        }));
        graficos.ticket_por_marca.sort((a, b) => b["Valor Avaliação"] - a["Valor Avaliação"]);
        graficos.ticket_por_marca = graficos.ticket_por_marca.slice(0, 20);

        // Ticket Médio por Vendedor
        const ticketPorVendedor = {};
        const contagemPorVendedor = {};

        dadosSemZeros.forEach(item => {
            const vendedor = item.Vendedor || 'Não informado';
            const valor = item.Valor_Avaliacao;

            if (!ticketPorVendedor[vendedor]) {
                ticketPorVendedor[vendedor] = 0;
                contagemPorVendedor[vendedor] = 0;
            }

            ticketPorVendedor[vendedor] += valor;
            contagemPorVendedor[vendedor]++;
        });

        graficos.ticket_por_vendedor = Object.keys(ticketPorVendedor).map(vendedor => ({
            Vendedor: vendedor,
            'Valor Avaliação': ticketPorVendedor[vendedor] / contagemPorVendedor[vendedor]
        }));
        graficos.ticket_por_vendedor.sort((a, b) => b["Valor Avaliação"] - a["Valor Avaliação"]);
        graficos.ticket_por_vendedor = graficos.ticket_por_vendedor.slice(0, 20);

        // Quantidade de Avaliações por Marca (Data de Avaliação)
        const avaliacoesPorMarca = {};
        dadosComDataAvaliacao.forEach(item => {
            const marca = item.Marca || 'Não informado';
            if (!avaliacoesPorMarca[marca]) {
                avaliacoesPorMarca[marca] = 0;
            }
            avaliacoesPorMarca[marca]++;
        });

        graficos.avaliacoes_por_marca = Object.keys(avaliacoesPorMarca).map(marca => ({
            Marca: marca,
            Quantidade: avaliacoesPorMarca[marca]
        }));
        graficos.avaliacoes_por_marca.sort((a, b) => b.Quantidade - a.Quantidade);
        graficos.avaliacoes_por_marca = graficos.avaliacoes_por_marca.slice(0, 10);

        // Quantidade de Avaliações por Vendedor (Data de Avaliação)
        const avaliacoesPorVendedor = {};
        dadosComDataAvaliacao.forEach(item => {
            const vendedor = item.Vendedor || 'Não informado';
            if (!avaliacoesPorVendedor[vendedor]) {
                avaliacoesPorVendedor[vendedor] = 0;
            }
            avaliacoesPorVendedor[vendedor]++;
        });

        graficos.avaliacoes_por_vendedor = Object.keys(avaliacoesPorVendedor).map(vendedor => ({
            Vendedor: vendedor,
            Quantidade: avaliacoesPorVendedor[vendedor]
        }));
        graficos.avaliacoes_por_vendedor.sort((a, b) => b.Quantidade - a.Quantidade);
        graficos.avaliacoes_por_vendedor = graficos.avaliacoes_por_vendedor.slice(0, 10);

        // Top 10 Modelos Mais Avaliados
        const avaliacoesPorModelo = {};
        dadosFiltrados.forEach(item => {
            const modelo = item.Modelo || 'Não informado';
            avaliacoesPorModelo[modelo] = (avaliacoesPorModelo[modelo] || 0) + 1;
        });
        graficos.modelos_mais_vendidos = Object.keys(avaliacoesPorModelo).map(modelo => ({
            Modelo: modelo,
            Quantidade: avaliacoesPorModelo[modelo]
        }));
        graficos.modelos_mais_vendidos.sort((a, b) => b.Quantidade - a.Quantidade);
        if (graficos.modelos_mais_vendidos.length > 10) {
            graficos.modelos_mais_vendidos = graficos.modelos_mais_vendidos.slice(0, 10);
        }

        // Top 10 Modelos Mais Próximos de 100% FIPE
        const somaPercPorModelo = {};
        const contagemPercModelo = {};
        dadosFiltrados.forEach(item => {
            const modelo = item.Modelo || 'Não informado';
            const percRaw = item.Percentual_FIPE;
            const perc = parseFloat(String(percRaw).replace(',', '.'));
            if (!isNaN(perc)) {
                somaPercPorModelo[modelo] = (somaPercPorModelo[modelo] || 0) + perc;
                contagemPercModelo[modelo] = (contagemPercModelo[modelo] || 0) + 1;
            }
        });
        graficos.modelos_proximos_fipe = Object.keys(somaPercPorModelo).map(modelo => ({
            Modelo: modelo,
            Percentual: somaPercPorModelo[modelo] / contagemPercModelo[modelo]
        }));
        graficos.modelos_proximos_fipe.sort((a, b) => Math.abs(100 - a.Percentual) - Math.abs(100 - b.Percentual));
        if (graficos.modelos_proximos_fipe.length > 10) {
            graficos.modelos_proximos_fipe = graficos.modelos_proximos_fipe.slice(0, 10);
        }

        // Captação por Vendedor
        const captacaoPorVendedor = {};
        // avaliacoesPorVendedor já foi calculado acima (linha 980)
        // const avaliacoesPorVendedor = {}; // Reutilizando o objeto avaliacoesPorVendedor
        
        dadosFiltrados.forEach(item => {
            const vendedor = item.Vendedor || 'Não informado';
            
            // Contagem de Captação
            const campo = item['Data de compra'];
            if (campo !== undefined && campo !== null && String(campo).trim() !== '') {
                captacaoPorVendedor[vendedor] = (captacaoPorVendedor[vendedor] || 0) + 1;
            }
        });
        
        graficos.captacao_por_vendedor = Object.keys(captacaoPorVendedor).map(vendedor => {
            const avaliacoes = avaliacoesPorVendedor[vendedor] || 0;
            const captacoes = captacaoPorVendedor[vendedor] || 0;
            const percentualConversao = avaliacoes > 0 ? (captacoes / avaliacoes) * 100 : 0;
            
            return {
                Vendedor: vendedor,
                Quantidade: captacoes,
                Avaliacoes: avaliacoes,
                PercentualConversao: percentualConversao
            };
        });
        
        graficos.captacao_por_vendedor.sort((a, b) => b.Quantidade - a.Quantidade);
        if (graficos.captacao_por_vendedor.length > 20) {
            graficos.captacao_por_vendedor = graficos.captacao_por_vendedor.slice(0, 20);
        }
    }
    
    function inicializarInterface() {
        inicializarGraficos();
        atualizarTabela();
        gerarStorytelling();
        document.getElementById('dataAtualizacao').textContent = moment().format('DD/MM/YYYY HH:mm');
    }
    
    function preencherFiltros() {
        const filtroMes = document.getElementById('filtroMes');
        const filtroLoja = document.getElementById('filtroLoja');
        const filtroVendedor = document.getElementById('filtroVendedor');
        const filtroMarca = document.getElementById('filtroMarca');
        const filtroModelo = document.getElementById('filtroModelo');
        
        filtroMes.innerHTML = '';
        filtroLoja.innerHTML = '';
        filtroVendedor.innerHTML = '';
        filtroMarca.innerHTML = '';
        filtroModelo.innerHTML = '';
        
        filtros.meses.forEach(mes => {
            const option = document.createElement('option');
            option.value = mes;
            option.textContent = mes;
            filtroMes.appendChild(option);
        });
        
        filtros.lojas.forEach(loja => {
            const option = document.createElement('option');
            option.value = loja;
            option.textContent = loja;
            filtroLoja.appendChild(option);
        });
        
        filtros.vendedores.forEach(vendedor => {
            const option = document.createElement('option');
            option.value = vendedor;
            option.textContent = vendedor;
            filtroVendedor.appendChild(option);
        });
        
        filtros.marcas.forEach(marca => {
            const option = document.createElement('option');
            option.value = marca;
            option.textContent = marca;
            filtroMarca.appendChild(option);
        });
        
        filtros.modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            filtroModelo.appendChild(option);
        });
        
        $('.select2-multiple').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Selecione...',
            allowClear: true
        });
    }
    
    function atualizarQuadros() {
        document.getElementById('totalAvaliacoes').textContent = formatadorNumero.format(quadros.total_avaliacoes);
        document.getElementById('ticketMedio').textContent = formatadorMoeda.format(quadros.ticket_medio);
        document.getElementById('kmMedia').textContent = formatadorNumero.format(quadros.km_media);
        document.getElementById('mediaAnos').textContent = formatadorAno.format(quadros.media_anos);
        document.getElementById('percentualFipe').textContent = formatadorDecimal.format(quadros.media_percentual_fipe) + '%';

        const elemCaptacaoQtd = document.getElementById('captacaoQuantidade');
        const elemCaptacaoPerc = document.getElementById('captacaoPercentual');
        if (elemCaptacaoQtd && elemCaptacaoPerc) {
            elemCaptacaoQtd.textContent = formatadorNumero.format(quadros.captacao_quantidade);
            elemCaptacaoPerc.textContent = formatadorDecimal.format(quadros.captacao_percentual);
        }
    }
    
    function inicializarGraficos() {
        const totalAvaliacoesGeral = dadosCompletos.length;
        if (chartTicketMarca) chartTicketMarca.destroy();
        if (chartTicketVendedor) chartTicketVendedor.destroy();
        if (chartAvaliacoesMarca) chartAvaliacoesMarca.destroy();
        if (chartAvaliacoesVendedor) chartAvaliacoesVendedor.destroy();
        if (chartModelosVendidos) chartModelosVendidos.destroy();
        if (chartModelosFipe) chartModelosFipe.destroy();
        if (chartCaptacaoVendedores) chartCaptacaoVendedores.destroy();

        // mapa de cores por marca
        const todasMarcas = Array.from(new Set([
            ...graficos.ticket_por_marca.map(item => item.Marca),
            ...graficos.avaliacoes_por_marca.map(item => item.Marca)
        ]));

        mapaCoresMarcas = {};
        todasMarcas.sort().forEach((marca, index) => {
            const corIndex = index % coresPrimarias.length;
            mapaCoresMarcas[marca] = {
                background: coresPrimarias[corIndex],
                border: coresBordas[corIndex]
            };
        });

        const obterCoresMarcas = (listaMarcas) => {
            return {
                background: listaMarcas.map(marca =>
                    mapaCoresMarcas[marca] ? mapaCoresMarcas[marca].background : coresPrimarias[0]
                ),
                border: listaMarcas.map(marca =>
                    mapaCoresMarcas[marca] ? mapaCoresMarcas[marca].border : coresBordas[0]
                )
            };
        };

        // Ticket Médio por Marca (barras horizontais)
        const ctxTicketMarca = document.getElementById('chartTicketMarca').getContext('2d');
        const labelsTicketMarca = graficos.ticket_por_marca.map(item => item.Marca);
        const coresTicketMarca = obterCoresMarcas(labelsTicketMarca);

        chartTicketMarca = new Chart(ctxTicketMarca, {
            type: 'bar',
            data: {
                labels: labelsTicketMarca,
                datasets: [{
                    label: 'Ticket Médio (R$)',
                    data: graficos.ticket_por_marca.map(item => item['Valor Avaliação']),
                    backgroundColor: coresTicketMarca.background,
                    borderColor: coresTicketMarca.border,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const marca = graficos.ticket_por_marca[context.dataIndex];
                                return formatadorMoeda.format(context.raw) +
                                    ' (' + formatadorNumero.format(marca.Quantidade) + ' avaliações)';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatadorMoeda.format(value);
                            }
                        }
                    }
                }
            }
        });

        // Ticket Médio por Vendedor (barras horizontais)
        const ctxTicketVendedor = document.getElementById('chartTicketVendedor').getContext('2d');
        chartTicketVendedor = new Chart(ctxTicketVendedor, {
            type: 'bar',
            data: {
                labels: graficos.ticket_por_vendedor.map(item => item.Vendedor),
                datasets: [{
                    label: 'Ticket Médio (R$)',
                    data: graficos.ticket_por_vendedor.map(item => item['Valor Avaliação']),
                    backgroundColor: coresPrimarias,
                    borderColor: coresBordas,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatadorMoeda.format(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatadorMoeda.format(value);
                            }
                        }
                    }
                }
            }
        });

        // Quantidade de Avaliações por Marca (AGORA BARRAS VERTICAIS)
        const ctxAvaliacoesMarca = document.getElementById('chartAvaliacoesMarca').getContext('2d');
        const labelsAvaliacoesMarca = graficos.avaliacoes_por_marca.map(item => item.Marca);
        const coresAvaliacoesMarca = obterCoresMarcas(labelsAvaliacoesMarca);

        chartAvaliacoesMarca = new Chart(ctxAvaliacoesMarca, {
            type: 'bar',
            data: {
                labels: labelsAvaliacoesMarca,
                datasets: [{
                    label: 'Quantidade de Avaliações',
                    data: graficos.avaliacoes_por_marca.map(item => item.Quantidade),
                    backgroundColor: coresAvaliacoesMarca.background,
                    borderColor: coresAvaliacoesMarca.border,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = totalAvaliacoesGeral; // Total de avaliações do dataset completo
                                const pct = ((ctx.raw / total) * 100).toFixed(1).replace('.', ',') + '%';
                                return formatadorNumero.format(ctx.raw) + ' (' + pct + ')';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Quantidade de Avaliações por Vendedor (barras verticais)
        const ctxAvaliacoesVendedor = document.getElementById('chartAvaliacoesVendedor').getContext('2d');
        chartAvaliacoesVendedor = new Chart(ctxAvaliacoesVendedor, {
            type: 'bar',
            data: {
                labels: graficos.avaliacoes_por_vendedor.map(item => item.Vendedor),
                datasets: [{
                    label: 'Quantidade de Avaliações',
                    data: graficos.avaliacoes_por_vendedor.map(item => item.Quantidade),
                    backgroundColor: coresPrimarias,
                    borderColor: coresBordas,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = totalAvaliacoesGeral; // Total de avaliações do dataset completo
                                const pct = ((ctx.raw / total) * 100).toFixed(1).replace('.', ',') + '%';
                                return formatadorNumero.format(ctx.raw) + ' (' + pct + ')';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });

        // Top 10 Modelos Mais Avaliados
        const ctxModelosVendidos = document.getElementById('chartModelosVendidos').getContext('2d');
        chartModelosVendidos = new Chart(ctxModelosVendidos, {
            type: 'bar',
            data: {
                labels: graficos.modelos_mais_vendidos.map(item => item.Modelo),
                datasets: [{
                    label: 'Avaliações',
                    data: graficos.modelos_mais_vendidos.map(item => item.Quantidade),
                    backgroundColor: coresPrimarias,
                    borderColor: coresBordas,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => formatadorNumero.format(ctx.raw) } }
                },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });

        // Top 10 Modelos Mais Bem Pagos
        const ctxModelosFipe = document.getElementById('chartModelosFipe').getContext('2d');
        chartModelosFipe = new Chart(ctxModelosFipe, {
            type: 'bar',
            data: {
                labels: graficos.modelos_proximos_fipe.map(item => item.Modelo),
                datasets: [{
                    label: 'Percentual Médio FIPE (%)',
                    data: graficos.modelos_proximos_fipe.map(item => item.Percentual),
                    backgroundColor: coresPrimarias,
                    borderColor: coresBordas,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => formatadorDecimal.format(ctx.raw) + '%' } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => formatadorDecimal.format(value) + '%'
                        }
                    }
                }
            }
        });

        // Captação por Vendedor
        const ctxCaptacaoVendedores = document.getElementById('chartCaptacaoVendedores').getContext('2d');
        const captacaoColors = graficos.captacao_por_vendedor.map((_, index) => coresPrimarias[index % coresPrimarias.length]);
        const captacaoBorderColors = graficos.captacao_por_vendedor.map((_, index) => coresBordas[index % coresBordas.length]);
        chartCaptacaoVendedores = new Chart(ctxCaptacaoVendedores, {
            type: 'bar',
            data: {
                labels: graficos.captacao_por_vendedor.map(item => item.Vendedor),
                datasets: [{
                    label: 'Captações',
                    data: graficos.captacao_por_vendedor.map(item => item.Quantidade),
                    backgroundColor: captacaoColors,
                    borderColor: captacaoBorderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const vendedorData = graficos.captacao_por_vendedor[context.dataIndex];
                                const conversaoFormatada = formatadorDecimal.format(vendedorData.PercentualConversao);
                                return 'Captações: ' + context.raw + ' (' + conversaoFormatada + '% de conversão)';
                            }
                        }
                    }
                },
                scales: {
                    x: { beginAtZero: true },
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    function atualizarTabela() {
        const tbody = document.querySelector('#tabelaAvaliacoes tbody');
        tbody.innerHTML = '';
        
        const inicio = (paginaAtual - 1) * itensPorPagina;
        const fim = Math.min(inicio + itensPorPagina, dadosFiltrados.length);
        
        for (let i = inicio; i < fim; i++) {
            const avaliacao = dadosFiltrados[i];
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${avaliacao.Data_Criacao ? moment(avaliacao.Data_Criacao).format('DD/MM/YYYY') : '-'}</td>
                <td>${avaliacao.Lojas || '-'}</td>
                <td>${avaliacao.Vendedor || '-'}</td>
                <td>${avaliacao.Cliente || '-'}</td>
                <td>${avaliacao['Placa da Avaliação'] || '-'}</td>
                <td>${avaliacao.Marca || '-'}</td>
                <td>${avaliacao.Modelo || '-'}</td>
                <td>${avaliacao.Ano || '-'}</td>
                <td>${formatadorNumero.format(avaliacao.KM || 0)}</td>
                <td>${formatadorMoeda.format(avaliacao.Valor_Avaliacao || 0)}</td>
                <td>${formatadorDecimal.format(avaliacao.Percentual_FIPE || 0)}%</td>
            `;
            
            tbody.appendChild(tr);
        }
        
        document.getElementById('tableInfo').textContent =
            `Mostrando ${dadosFiltrados.length === 0 ? 0 : inicio + 1} a ${fim} de ${dadosFiltrados.length} registros`;
        
        atualizarPaginacao();
    }
    
    function atualizarPaginacao() {
        const paginationElement = document.getElementById('tablePagination');
        paginationElement.innerHTML = '';
        
        const totalPaginas = Math.ceil(dadosFiltrados.length / itensPorPagina) || 1;
        
        const liAnterior = document.createElement('li');
        liAnterior.className = `page-item ${paginaAtual === 1 ? 'disabled' : ''}`;
        liAnterior.innerHTML = `<a class="page-link" href="#" aria-label="Anterior"><span aria-hidden="true">&laquo;</span></a>`;
        liAnterior.addEventListener('click', (e) => {
            e.preventDefault();
            if (paginaAtual > 1) {
                paginaAtual--;
                atualizarTabela();
            }
        });
        paginationElement.appendChild(liAnterior);
        
        const maxPaginas = 5;
        let startPage = Math.max(1, paginaAtual - Math.floor(maxPaginas / 2));
        let endPage = Math.min(totalPaginas, startPage + maxPaginas - 1);
        
        if (endPage - startPage + 1 < maxPaginas) {
            startPage = Math.max(1, endPage - maxPaginas + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === paginaAtual ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                paginaAtual = i;
                atualizarTabela();
            });
            paginationElement.appendChild(li);
        }
        
        const liProximo = document.createElement('li');
        liProximo.className = `page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}`;
        liProximo.innerHTML = `<a class="page-link" href="#" aria-label="Próximo"><span aria-hidden="true">&raquo;</span></a>`;
        liProximo.addEventListener('click', (e) => {
            e.preventDefault();
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                atualizarTabela();
            }
        });
        paginationElement.appendChild(liProximo);
    }
    
    function aplicarFiltros() {
        const mesesSelecionados = Array.from(document.getElementById('filtroMes').selectedOptions).map(option => option.value);
        const lojasSelecionadas = Array.from(document.getElementById('filtroLoja').selectedOptions).map(option => option.value);
        const vendedoresSelecionados = Array.from(document.getElementById('filtroVendedor').selectedOptions).map(option => option.value);
        const marcasSelecionadas = Array.from(document.getElementById('filtroMarca').selectedOptions).map(option => option.value);
        const modelosSelecionados = Array.from(document.getElementById('filtroModelo').selectedOptions).map(option => option.value);
        
        const buscaPlaca = document.getElementById('buscaPlaca').value.trim().toLowerCase();
        buscaPlacaAtiva = buscaPlaca;
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        dadosFiltrados = dadosCompletos.filter(item => {
            const mesMatch = mesesSelecionados.length === 0 || mesesSelecionados.includes(item.Mes_Ano);
            const lojaMatch = lojasSelecionadas.length === 0 || lojasSelecionadas.includes(item.Lojas);
            const vendedorMatch = vendedoresSelecionados.length === 0 || vendedoresSelecionados.includes(item.Vendedor);
            const marcaMatch = marcasSelecionadas.length === 0 || marcasSelecionadas.includes(item.Marca);
            const modeloMatch = modelosSelecionados.length === 0 || modelosSelecionados.includes(item.Modelo);
            
            const placaMatch = buscaPlaca === '' || (item['Placa da Avaliação'] &&
                item['Placa da Avaliação'].toString().toLowerCase().includes(buscaPlaca));
            
            return mesMatch && lojaMatch && vendedorMatch && marcaMatch && modeloMatch && placaMatch;
        });
        
        calcularEstatisticas();
        calcularDadosGraficos();
        inicializarGraficos();
        paginaAtual = 1;
        atualizarTabela();
        gerarStorytelling();
        
        const clearBtn = document.getElementById('clearSearchBtn');
        if (buscaPlaca) {
            clearBtn.style.display = 'block';
        } else {
            clearBtn.style.display = 'none';
        }
        
        document.getElementById('loadingOverlay').style.display = 'none';
    }
    
    function limparFiltros() {
        $('.select2-multiple').val(null).trigger('change');
        
        document.getElementById('buscaPlaca').value = '';
        document.getElementById('clearSearchBtn').style.display = 'none';
        buscaPlacaAtiva = '';
        
        aplicarFiltros();
    }
    
    function gerarStorytelling() {
        const storyContent = document.getElementById('storyContent');
        const totalAvaliacoes = dadosFiltrados.length;
        
        if (totalAvaliacoes === 0) {
            storyContent.innerHTML = `
                <p>Não há dados disponíveis para os filtros selecionados. Por favor, ajuste os filtros para visualizar os insights.</p>
            `;
            return;
        }
        
        const marcasPorQuantidade = {};
        dadosFiltrados.forEach(item => {
            const marca = item.Marca || 'Não informado';
            marcasPorQuantidade[marca] = (marcasPorQuantidade[marca] || 0) + 1;
        });
        
        const marcaMaisAvaliada = Object.keys(marcasPorQuantidade).reduce((a, b) => 
            marcasPorQuantidade[a] > marcasPorQuantidade[b] ? a : b
        );
        
        const quantidadeMarcaMaisAvaliada = marcasPorQuantidade[marcaMaisAvaliada];
        const percentualMarcaMaisAvaliada = (quantidadeMarcaMaisAvaliada / totalAvaliacoes * 100).toFixed(1);

        const modelosPorQuantidade = {};
        dadosFiltrados.forEach(item => {
            const modelo = (item.Modelo || item['Modelo Veículo'] || item['Modelo do Veículo'] || item['ModeloVeiculo'] || 'Não informado').toString().trim();
            modelosPorQuantidade[modelo] = (modelosPorQuantidade[modelo] || 0) + 1;
        });
        const modeloMaisAvaliado = Object.keys(modelosPorQuantidade).reduce((a, b) =>
            modelosPorQuantidade[a] > modelosPorQuantidade[b] ? a : b
        );
        const quantidadeModeloMaisAvaliado = modelosPorQuantidade[modeloMaisAvaliado];
        const percentualModeloMaisAvaliado = (quantidadeModeloMaisAvaliado / totalAvaliacoes * 100).toFixed(1);

        const contagemAvaliacoesPorVendedor = {};
        dadosFiltrados.forEach(item => {
            const vend = (item.Vendedor || 'Não informado').toString().trim();
            contagemAvaliacoesPorVendedor[vend] = (contagemAvaliacoesPorVendedor[vend] || 0) + 1;
        });
        const vendedorMaisAvaliacoes = Object.keys(contagemAvaliacoesPorVendedor).reduce((a,b)=>
            contagemAvaliacoesPorVendedor[a] > contagemAvaliacoesPorVendedor[b] ? a : b
        );
        const quantidadeVendedorMaisAvaliacoes = contagemAvaliacoesPorVendedor[vendedorMaisAvaliacoes];

        const vendedoresSemZeros = {};
        const contagemVendedores = {};
        
        dadosFiltrados.forEach(item => {
            if (item.Valor_Avaliacao > 0) {
                const vendedor = item.Vendedor || 'Não informado';
                const valor = item.Valor_Avaliacao;
                
                vendedoresSemZeros[vendedor] = (vendedoresSemZeros[vendedor] || 0) + valor;
                contagemVendedores[vendedor] = (contagemVendedores[vendedor] || 0) + 1;
            }
        });
        
        const ticketMedioPorVendedor = {};
        Object.keys(vendedoresSemZeros).forEach(vendedor => {
            ticketMedioPorVendedor[vendedor] = vendedoresSemZeros[vendedor] / contagemVendedores[vendedor];
        });
        
        const vendedorMaiorTicket = Object.keys(ticketMedioPorVendedor).reduce((a, b) => 
            ticketMedioPorVendedor[a] > ticketMedioPorVendedor[b] ? a : b
        );
        
        const maiorTicketMedio = ticketMedioPorVendedor[vendedorMaiorTicket];
        
        const lojasPorQuantidade = {};
        dadosFiltrados.forEach(item => {
            const loja = item.Lojas || 'Não informado';
            lojasPorQuantidade[loja] = (lojasPorQuantidade[loja] || 0) + 1;
        });
        
        const lojaMaisAvaliacoes = Object.keys(lojasPorQuantidade).reduce((a, b) => 
            lojasPorQuantidade[a] > lojasPorQuantidade[b] ? a : b
        );
        
        const quantidadeLojaMaisAvaliacoes = lojasPorQuantidade[lojaMaisAvaliacoes];
        const percentualLojaMaisAvaliacoes = (quantidadeLojaMaisAvaliacoes / totalAvaliacoes * 100).toFixed(1);
        
        let textoBuscaPlaca = '';
        if (buscaPlacaAtiva) {
            textoBuscaPlaca = `<p><strong>Filtro ativo:</strong> Resultados filtrados pela placa "${buscaPlacaAtiva.toUpperCase()}".</p>`;
        }
        
        storyContent.innerHTML = `
            ${textoBuscaPlaca}
            <p>Analisando as <strong>${formatadorNumero.format(totalAvaliacoes)}</strong> avaliações de veículos, 
            identificamos que a marca <strong>${marcaMaisAvaliada}</strong> representa 
            <strong>${percentualMarcaMaisAvaliada}%</strong> do total, com 
            <strong>${formatadorNumero.format(quantidadeMarcaMaisAvaliada)}</strong> avaliações.</p>
            
            <p>O modelo <strong>${modeloMaisAvaliado}</strong> concentra 
            <strong>${percentualModeloMaisAvaliado}%</strong> das avaliações, totalizando 
            <strong>${formatadorNumero.format(quantidadeModeloMaisAvaliado)}</strong> registros.</p>

            <p>O vendedor com maior volume de avaliações é <strong>${vendedorMaisAvaliacoes}</strong>, com 
            <strong>${formatadorNumero.format(quantidadeVendedorMaisAvaliacoes)}</strong> avaliações registradas, 
            enquanto o maior ticket médio está com <strong>${vendedorMaiorTicket}</strong>, com uma média de 
            <strong>${formatadorMoeda.format(maiorTicketMedio)}</strong> por avaliação.</p>
            
            <p>Entre as lojas, <strong>${lojaMaisAvaliacoes}</strong> se destaca com 
            <strong>${formatadorNumero.format(quantidadeLojaMaisAvaliacoes)}</strong> avaliações, o que representa 
            <strong>${percentualLojaMaisAvaliacoes}%</strong> do total analisado.</p>
        `;
    }

    function exportarExcel() {
        try {
            if (!dadosFiltrados || dadosFiltrados.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }
            const wb = XLSX.utils.book_new();
            const dadosExport = dadosFiltrados.map(item => ({
                'Data': item.Data_Criacao ? moment(item.Data_Criacao).format('DD/MM/YYYY') : '',
                'Loja': item.Lojas || '',
                'Vendedor': item.Vendedor || '',
                'Cliente': item.Cliente || '',
                'Placa': item['Placa da Avaliação'] || '',
                'Marca': item.Marca || '',
                'Modelo': item.Modelo || '',
                'Ano': item.Ano || '',
                'KM': item.KM || 0,
                'Valor Avaliação': item.Valor_Avaliacao || 0,
                '% FIPE': item.Percentual_FIPE || 0
            }));
            const ws = XLSX.utils.json_to_sheet(dadosExport);
            XLSX.utils.book_append_sheet(wb, ws, 'Avaliações');
            XLSX.writeFile(wb, 'avaliacoes_filtradas.xlsx');
        } catch (error) {
            console.error('Erro ao exportar Excel:', error);
            alert('Erro ao exportar dados para Excel.');
        }
    }

    function exportarPDF() {
        try {
            if (!dadosFiltrados || dadosFiltrados.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }

            document.getElementById('loadingOverlay').style.display = 'flex';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt');

            doc.setFontSize(14);
            doc.text('Relatório de Avaliações de Veículos', 40, 40);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${moment().format('DD/MM/YYYY HH:mm')}`, 40, 58);

            const dadosTabela = dadosFiltrados.map(item => [
                item.Data_Criacao ? moment(item.Data_Criacao).format('DD/MM/YYYY') : '',
                item.Lojas || '',
                item.Vendedor || '',
                item.Cliente || '',
                item['Placa da Avaliação'] || '',
                item.Marca || '',
                item.Modelo || '',
                item.Ano || '',
                formatadorNumero.format(item.KM || 0),
                formatadorMoeda.format(item.Valor_Avaliacao || 0),
                formatadorDecimal.format(item.Percentual_FIPE || 0) + '%'
            ]);

            doc.autoTable({
                startY: 70,
                head: [[
                    'Data', 'Loja', 'Vendedor', 'Cliente', 'Placa',
                    'Marca', 'Modelo', 'Ano', 'KM', 'Valor', '% FIPE'
                ]],
                body: dadosTabela,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 152, 219] }
            });

            doc.save('avaliacoes_filtradas.pdf');
            document.getElementById('loadingOverlay').style.display = 'none';
        } catch (error) {
            console.error('Erro ao exportar PDF:', error);
            alert('Erro ao exportar dados para PDF.');
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loadingOverlay').style.display = 'none';
        
        document.getElementById('btnAplicarFiltros').addEventListener('click', aplicarFiltros);
        document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltros);
        
        document.getElementById('fileUpload').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processarArquivoExcel(e.target.files[0]);
            }
        });
        
        document.getElementById('btnExportarExcel').addEventListener('click', exportarExcel);
        document.getElementById('btnExportarPDF').addEventListener('click', exportarPDF);
        
        const buscaPlacaInput = document.getElementById('buscaPlaca');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        
        let timeoutBusca;
        buscaPlacaInput.addEventListener('input', () => {
            clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(() => {
                aplicarFiltros();
            }, 500);
        });
        
        buscaPlacaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(timeoutBusca);
                aplicarFiltros();
            }
        });
        
        clearSearchBtn.addEventListener('click', () => {
            buscaPlacaInput.value = '';
            clearSearchBtn.style.display = 'none';
            aplicarFiltros();
        });
        
        document.getElementById('dataAtualizacao').textContent = moment().format('DD/MM/YYYY HH:mm');
    });
</script>

</body>
</html>
